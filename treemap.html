<!DOCTYPE html>
<meta charset="utf-8">
<html>

<head>
    <title>Stock Market News' Emotions</title>
</head>
<style>
    body {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        width: 100%;
        height: 100%;
        /*position: relative;*/
        padding-left: 5px;
        align: "center";
    }
</style>

<body>
<div style="background-color:white", align="center">
    <!--<h3><span id="countryName"></span>, <span id="day"></span></h3>-->
</div>

<!-- load D3js -->
<script src="//d3plus.org/js/d3.js"></script>

<!-- load D3plus after D3js -->
<script src="//d3plus.org/js/d3plus.js"></script>

<script src="https://d3plus.org/js/d3plus.v2.0.0-alpha.17.full.min.js"></script>

<!-- create container element for visualization -->
<div id="viz"></div>

<script>

        /*
        These variables (country and day) are send by the map.html file
         */

        // get the name of the country clicked on map.html
        var country = sessionStorage.getItem("country");
        console.log(country);
        //get the day
        var month = sessionStorage.getItem("month");
        console.log(month);
        // var day = sessionStorage.getItem("day");

        // document.getElementById("countryName").innerHTML = country;
        // document.getElementById("month").innerHTML = month ;
        // formatDate(day);

        // read, filter and select only the Emotion and Count columns from the data
        d3.csv("data/data_Jan-May2018.csv", function(data) {
            var dataFiltered = data.filter(function (d) {
                if (d["Country"] == country && d["Month"] == month) {
                    return d;
                }
            });
            console.log(data);
            console.log(dataFiltered);

            var emotions = dataFiltered.map(function (d) {
                return {
                    //Country: d.Country,
                    emotion: d.Emotion.charAt(0).toUpperCase() + d.Emotion.slice(1),
                    news: Number(d.Count), // to the treemap plot work properly, this value must be a number and not a String
                    day: d.Date
                    //color: getRandomColor().toString() // color variable added in order to have customized colors for each emotion
                }
            });

            console.log(emotions);

            /*
            http://d3plus.org/examples/basic/9029130/s
             */

            new d3plus.Treemap()
                .data(emotions)
                .groupBy("emotion")
                .tooltipConfig({
                    body: function(d) {
                        var table = "<table class='tooltip-table'>";
                        table += "<tr><td class='title'>Number of News:</td><td class='data'>" + d.news + "</td></tr>";
                        table += "</table>";
                        return table;
                    },
                    footer: function(d) {
                        return "<sub class='tooltip-footer'>Data from " + d.day + "</sub>";
                    },
                    title: function(d) {
                        var txt = d.emotion;
                        return txt;
                    }
                })
                .on("click", function(d) {
                    sessionStorage.setItem("emotion", d.emotion.toLowerCase());
                    window.open("data/cards.html", "_self");
                    // window.open("data/cards.html" ,"cards", "resizable=yes,height=600, width=500");
                })
                .select("#viz")
                .sum("news")
                .render();
        })


        // We need to rewrite this function.
        // The idea is to return one color for each emotion, based on how positive or negative the emotion is
        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // function formatDate(date) {
        //     var monthNames = [
        //         "January", "February", "March",
        //         "April", "May", "June", "July",
        //         "August", "September", "October",
        //         "November", "December"
        //     ];
        //
        //     date = new Date(date)
        //     var day = date.getDate();
        //     var monthIndex = date.getMonth();
        //     var year = date.getFullYear();
        //
        //     return day + ' ' + monthNames[monthIndex] + ' ' + year;
        // }

</script>
</body>
</html>